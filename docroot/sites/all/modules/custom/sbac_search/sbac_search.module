<?php
/**
 * @file
 * Code for the SBAC Search feature.
 */

include_once 'sbac_search.features.inc';

define('SBAC_SEARCH_MY_RESOURCES_FILTERS', 'sbac-my-resources-filters');
define('SBAC_SEARCH_DIGITAL_LIBRARY_RESOURCES_FILTERS', 'sbac-digital-library-filters');
define('SBAC_SEARCH_RESOURCE_REVIEW_FILTERS', 'sbac-resource-review-filters');

define('SBAC_SEARCH_MY_RESOURCES_COUNT', 'sbac-my-resources-count');
define('SBAC_SEARCH_DIGITAL_LIBRARY_RESOURCES_COUNT', 'sbac-digital-library-count');
define('SBAC_SEARCH_RESOURCE_REVIEW_COUNT', 'sbac-resource-review-count');

define('SBAC_SEARCH_MY_RESOURCES_FILTERS_CLOSED', 'sbac-my-resources-filters-closed');
define('SBAC_SEARCH_DIGITAL_LIBRARY_FILTERS_CLOSED', 'sbac-digital-library-filters-closed');
define('SBAC_SEARCH_RESOURCE_REVIEW_FILTERS_CLOSED', 'sbac-resource-review-filters-closed');

define('SBAC_SEARCH_DIGITAL_LIBRARY_KEYWORDS', 'sbac-search-digital-library-keywords');

/**
 * Implements hook_update_projects_alter().
 *
 * @param $projects
 */
function sbac_search_update_projects_alter(&$projects) {
  unset($projects['sbac_search']);
}

/**
 * Implements hook_apachesolr_environments().
 * Component alter.
 *
 * @param $environments
 */
function sbac_search_apachesolr_environments_alter(&$environments) {
  if (!isset($_ENV['AH_SITE_ENVIRONMENT'])) {
    if (isset($environments['acquia_search_server_1'])) {
      $environments['acquia_search_server_1']->conf['apachesolr_read_only'] = '1';
    }
  }
}

/**
 * Implements hook_menu().
 *
 * @return mixed
 */
function sbac_search_menu() {
  $items = array();

  $items['sbac-search/clear-all'] = array(
    'title' => 'Digital Library Resources',
    'page callback' => 'sbac_resource_clear_library_page',
    'access arguments' => array('access content'),
    'type' => MENU_CALLBACK,
  );

  return $items;
}

/**
 * Implementation of hook_preprocess_page()
 *
 * @param $vars
 */
function sbac_search_preprocess_page(&$vars) {
  if (strpos($_GET['q'], 'digital-library-resources') !== FALSE) {
    $search_term = '/search_results.php';
    if (isset($_SESSION[SBAC_SEARCH_DIGITAL_LIBRARY_KEYWORDS]) && $_SESSION[SBAC_SEARCH_DIGITAL_LIBRARY_KEYWORDS]) {
      $search_term = '/search_results.php?q=' . $_SESSION[SBAC_SEARCH_DIGITAL_LIBRARY_KEYWORDS];
      $_SESSION[SBAC_SEARCH_DIGITAL_LIBRARY_KEYWORDS] = '';
    }

//    var pageTracker = _gat._getTracker(\"UA-27429193-1\");
//    pageTracker._initData();
//    pageTracker._trackPageview(\"" . $search_term . "\");
    $js =  "var pageTracker1 = _gat._getTracker(\"UA-27429193-1\");
            pageTracker1._initData();
            pageTracker1._trackPageview(\"" . $search_term . "\");";
    drupal_add_js($js, array('type' => 'inline', 'scope' => 'footer', 'weight' => 5));
  }
}

/**
 * Clears the search filters and redirects.
 */
function sbac_resource_clear_library_page() {
  if (isset($_GET['location'])) {
    $location = $_GET['location'];
    switch ($location) {
      case 'digital-library-resources':
        $_SESSION[SBAC_SEARCH_DIGITAL_LIBRARY_RESOURCES_FILTERS] = '';
        $_SESSION[SBAC_SEARCH_DIGITAL_LIBRARY_KEYWORDS] = '';
        drupal_goto($location);
        break;
      case 'my-resources':
        $_SESSION[SBAC_SEARCH_MY_RESOURCES_FILTERS] = '';
        drupal_goto($location);
        break;
      case 'resource-review':
        $_SESSION[SBAC_SEARCH_RESOURCE_REVIEW_FILTERS] = '';
        drupal_goto($location);
        break;
    }
  }

  $_SESSION[SBAC_SEARCH_DIGITAL_LIBRARY_RESOURCES_FILTERS] = '';
  $_SESSION[SBAC_SEARCH_DIGITAL_LIBRARY_KEYWORDS] = '';
  drupal_goto('digital-library-resources');
}

/**
 * Build the documents before sending them to Solr.
 *
 * Supports all types of
 * hook_apachesolr_index_document_build_' . $entity_type($documents[$id], $entity, $env_id);
 *
 * The function is the follow-up for apachesolr_update_index but then for
 * specific entity types
 *
 * @param ApacheSolrDocument $document
 * @param object $entity
 * @param string $env_id
 *   The machine name of the environment.
 */
function sbac_search_apachesolr_index_document_build_user(ApacheSolrDocument $document, $entity, $env_id) {
  $user = user_load($entity->uid);

  if (isset($user->field_first_name['und'][0]['value'])) {
    $document->ss_first_name = $user->field_first_name['und'][0]['value'];
  }
  if (isset($user->field_last_name['und'][0]['value'])) {
    $document->ss_last_name = $user->field_last_name['und'][0]['value'];
  }
  if (isset($user->field_alternate_email_address['und'][0]['value'])) {
    $document->ss_alternate_email = $user->field_alternate_email_address['und'][0]['value'];
  }
  if (isset($user->field_phone_number['und'][0]['value'])) {
    $document->ss_phone_number = $user->field_phone_number['und'][0]['value'];
  }

  if (isset($user->field_school_name['und'])) {
    foreach ($user->field_school_name['und'] as $key => $value) {
      if (isset($value['value'])) {
        $document->setMultiValue('sm_school_name', $value['value']);
      }
    }
  }

  if (isset($user->field_district_name['und'][0]['value'])) {
    $document->ss_district_name = $user->field_district_name['und'][0]['value'];
  }
  if  (isset($user->field_university_name['und'][0]['value'])) {
    $document->ss_university_name = $user->field_university_name['und'][0]['value'];
  }

  if (isset($user->field_subject_s_['und'])) {
    foreach ($user->field_subject_s_['und'] as $key => $value) {
      if (isset($value['value'])) {
        $document->setMultiValue('sm_subject_s', $value['value']);
      }
    }
  }

  if (isset($user->field_grade_level_s_['und'])) {
    foreach ($user->field_grade_level_s_['und'] as $key => $value) {
      if (isset($value['value'])) {
        $document->setMultiValue('sm_grade_level_s', $val);
      }
    }
  }
}


/**
 * Implements hook_facetapi_facet_info().
 */
function sbac_search_facetapi_facet_info($searcher_info) {
  $facets = array();
  if (isset($searcher_info['types']['user'])) {
    $facets['school_name'] = array(
      'label' => t('School Name'),
      'description' => t('Filter by School Name.'),
      'field' => 'sm_school_name',
      'values callback' => 'facetapi_callback_user_values',
      'facet mincount allowed' => TRUE,
    );

    $facets['district_name'] = array(
      'label' => t('District Name'),
      'description' => t('Filter by District Name.'),
      'field' => 'ss_district_name',
      'values callback' => 'facetapi_callback_user_values',
      'facet mincount allowed' => TRUE,
    );

    $facets['university_name'] = array(
      'label' => t('University Name'),
      'description' => t('Filter by University Name.'),
      'field' => 'ss_university_name',
      'values callback' => 'facetapi_callback_user_values',
      'facet mincount allowed' => TRUE,
    );

    $facets['subjects'] = array(
      'label' => t('Subjects'),
      'description' => t('Filter by Subjects.'),
      'field' => 'sm_subject_s',
      'values callback' => 'facetapi_callback_user_values',
      'facet mincount allowed' => TRUE,
    );

    $facets['grade_levels'] = array(
      'label' => t('Grade Levels'),
      'description' => t('Filter by Grade Levels.'),
      'field' => 'sm_grade_level_s',
      'values callback' => 'facetapi_callback_user_values',
      'facet mincount allowed' => TRUE,
    );

    // Add facets for all fields attached to the user entity.
    $facets = array_merge($facets, apachesolr_entity_field_facets('user'));
  }
  return $facets;
}

/**
 * Implements hook_block_info().
 *
 * @return mixed
 */
function sbac_search_block_info() {
  $blocks['sbac_search_categories'] = array(
    'info' => t('Categories'),
    'region' => 'filter',
    'pages' => "digital-library-resources*\nmy-resources*\nresource-review*",
    'visibility' => BLOCK_VISIBILITY_LISTED,
    'status' => 1,
    'cache' => DRUPAL_NO_CACHE,
  );

  $blocks['sbac_search_categories_button'] = array(
    'info' => t('Categories'),
    'region' => 'search',
    'pages' => "digital-library-resources*\nmy-resources*\nresource-review*",
    'visibility' => BLOCK_VISIBILITY_LISTED,
    'status' => 1,
    'cache' => DRUPAL_NO_CACHE,
    'weight' => 1,
  );

  return $blocks;
}

/**
 * Implements hook_block_info_alter().
 *
 * @param $blocks
 * @param $theme
 * @param $code_blocks
 */
function sbac_search_block_info_alter(&$blocks, $theme, $code_blocks) {
  $blocks['search']['form']['status'] = TRUE;
  $blocks['search']['form']['region'] = 'search';
  $blocks['search']['form']['visibility'] = BLOCK_VISIBILITY_LISTED;
  $blocks['search']['form']['pages'] = "digital-library-resources*\ncontent*";
  $blocks['search']['form']['weight'] = 2;

  if (isset($blocks['sbac_search']['sbac_search_categories']) && $theme == 'SBAC') {
    $blocks['sbac_search']['sbac_search_categories']['pages'] = "digital-library-resources*\nmy-resources*\nresource-review*";
  }
  if (isset($blocks['sbac_search']['sbac_search_categories_button']) && $theme = 'SBAC') {
    $blocks['sbac_search']['sbac_search_categories_button']['pages'] = "digital-library-resources*\nmy-resources*\nresource-review*";
  }
}

/**
 * Implements hook_block_view().
 *
 * @param string $delta
 *
 * @return array
 */
function sbac_search_block_view($delta = '') {
  $block = array();
  switch ($delta) {
    case 'sbac_search_categories':
      $block['subject'] = t('');
      switch (arg(0)) {
        case 'my-resources':
          $block['content'] = drupal_get_form('sbac_search_my_resources_form');
          break;
        case 'digital-library-resources':
          $block['content'] = drupal_get_form('sbac_search_digital_library_resources_form');
          break;
        case 'resource-review':
          $block['content'] = drupal_get_form('sbac_search_resource_review_form');
          break;
        default:
          $block['content'] = drupal_get_form('sbac_search_digital_library_resources_form');
          break;
      }

      break;
    case 'sbac_search_categories_button':
      $block['subject'] = t('');
      $content = '<a href="#" data-tooltip title="Categories allow you to filter results using specific attributes. Click to see the available options." id="sbac-search-cat-button" class="active">' . t('Categories') . '</a>';
      $block['content'] = $content;
      break;
  }
  return $block;
}

/*
 * Hides category filter if called
 */
function sbac_search_hide_category_style() {
  if (arg(0) == 'digital-library-resources' && isset($_COOKIE[SBAC_SEARCH_DIGITAL_LIBRARY_FILTERS_CLOSED]) && $_COOKIE[SBAC_SEARCH_DIGITAL_LIBRARY_FILTERS_CLOSED]) {
    return ' style="display:none;"';
  }
  if (arg(0) == 'my-resources' && isset($_COOKIE[SBAC_SEARCH_MY_RESOURCES_FILTERS_CLOSED]) && $_COOKIE[SBAC_SEARCH_MY_RESOURCES_FILTERS_CLOSED]) {
    return ' style="display:none;"';
  }
  if (arg(0) == 'resource-review' && isset($_COOKIE[SBAC_SEARCH_RESOURCE_REVIEW_FILTERS_CLOSED]) && $_COOKIE[SBAC_SEARCH_RESOURCE_REVIEW_FILTERS_CLOSED]) {
    return ' style="display:none;"';
  }
}

/**
 * Form for submitting the category filters.
 *
 * @return array
 */
function sbac_search_my_resources_form() {
  $form = array();

  $current_filters = NULL;
  if (isset($_SESSION[SBAC_SEARCH_MY_RESOURCES_FILTERS])) {
    $current_filters = $_SESSION[SBAC_SEARCH_MY_RESOURCES_FILTERS];
  }

  $form['current_filters'] = array(
    '#type' => 'hidden',
    '#value' => $current_filters,
    '#attributes' => array('id' => 'sbac-search-current-filters'),
  );

  $form['search_categories'] = array(
    '#markup' => sbac_search_my_resources_categories(),
  );

  $form['close'] = array(
    '#type' => 'submit',
    '#value' => 'Close',
    '#attributes' => array('id' => 'sbac-search-close-button'),
    '#prefix' => '<div class="category-buttons slideable">',
    '#ajax' => array(
      'wrapper' => '',
      'method' => 'replace',
      'effect' => 'fade'
    ),
  );

  $form['filter'] = array(
    '#type' => 'submit',
    '#value' => 'Apply Filters',
    '#attributes' => array('id' => 'sbac-search-filter-button'),
    '#suffix' => '</div>',
    '#ajax' => array(
      'wrapper' => '',
      'method' => 'replace',
      'effect' => 'fade'
    ),
  );

  return $form;
}

/**
 * Submit handler for categories.
 *
 * @param $form
 * @param $form_state
 */
function sbac_search_my_resources_form_submit(&$form, &$form_state) {
  $_SESSION[SBAC_SEARCH_MY_RESOURCES_FILTERS] = $form_state['input']['current_filters'];
}

/**
 * Form for submitting the category filters.
 *
 * @return array
 */
function sbac_search_resource_review_form() {
  $form = array();

  $current_filters = NULL;
  if (isset($_SESSION[SBAC_SEARCH_RESOURCE_REVIEW_FILTERS])) {
    $current_filters = $_SESSION[SBAC_SEARCH_RESOURCE_REVIEW_FILTERS];
  }

  $form['current_filters'] = array(
    '#type' => 'hidden',
    '#value' => $current_filters,
    '#attributes' => array('id' => 'sbac-search-current-filters'),
  );

  $form['search_categories'] = array(
    '#markup' => sbac_search_resource_review_categories(),
  );

  $form['close'] = array(
    '#type' => 'submit',
    '#value' => 'Close',
    '#attributes' => array('id' => 'sbac-search-close-button'),
    '#prefix' => '<div class="category-buttons">',
    '#ajax' => array(
      'wrapper' => '',
      'method' => 'replace',
      'effect' => 'fade'
    ),
  );

  $form['filter'] = array(
    '#type' => 'submit',
    '#value' => 'Apply Filters',
    '#attributes' => array('id' => 'sbac-search-filter-button'),
    '#suffix' => '</div>',
    '#ajax' => array(
      'wrapper' => '',
      'method' => 'replace',
      'effect' => 'fade'
    ),
  );

  return $form;
}

/**
 * Submit handler for categories.
 *
 * @param $form
 * @param $form_state
 */
function sbac_search_resource_review_form_submit(&$form, &$form_state) {
  $_SESSION[SBAC_SEARCH_RESOURCE_REVIEW_FILTERS] = $form_state['input']['current_filters'];
}

/**
 * Form for submitting the category filters.
 *
 * @return array
 */
function sbac_search_digital_library_resources_form() {
  $form = array();

  $current_filters = NULL;
  if (isset($_SESSION[SBAC_SEARCH_DIGITAL_LIBRARY_RESOURCES_FILTERS])) {
    $current_filters = $_SESSION[SBAC_SEARCH_DIGITAL_LIBRARY_RESOURCES_FILTERS];
  }

  $form['current_filters'] = array(
    '#type' => 'hidden',
    '#value' => $current_filters,
    '#attributes' => array('id' => 'sbac-search-current-filters'),
  );

  $form['search_categories'] = array(
    '#markup' => sbac_search_digital_library_categories(),
  );

  $current_keywords = NULL;
  if (isset($_SESSION[SBAC_SEARCH_DIGITAL_LIBRARY_KEYWORDS])) {
    $current_keywords = $_SESSION[SBAC_SEARCH_DIGITAL_LIBRARY_KEYWORDS];
  }
  $form['search_keywords'] = array(
    '#type' => 'hidden',
    '#value' => $current_keywords,
    '#attributes' => array('id' => 'sbac-search-keywords'),
  );

  $form['close'] = array(
    '#type' => 'submit',
    '#value' => 'Close',
    '#attributes' => array('id' => 'sbac-search-close-button'),
    '#prefix' => '<div class="category-buttons">',
    '#ajax' => array(
      'wrapper' => '',
      'method' => 'replace',
      'effect' => 'fade'
    ),
  );

  $form['filter'] = array(
    '#type' => 'submit',
    '#value' => 'Apply Filters',
    '#attributes' => array('id' => 'sbac-search-filter-button'),
    '#suffix' => '</div>',
    '#ajax' => array(
      'wrapper' => '',
      'method' => 'replace',
      'effect' => 'fade'
    ),
  );

  return $form;
}

/**
 * Submit handler for categories.
 *
 * @param $form
 * @param $form_state
 */
function sbac_search_digital_library_resources_form_submit(&$form, &$form_state) {
  $_SESSION[SBAC_SEARCH_DIGITAL_LIBRARY_RESOURCES_FILTERS] = $form_state['input']['current_filters'];
  if (isset($_SESSION[SBAC_SEARCH_DIGITAL_LIBRARY_KEYWORDS])) {
    $current_keywords = $_SESSION[SBAC_SEARCH_DIGITAL_LIBRARY_KEYWORDS];
    // If the keywords are different, remove filters.
    if ($current_keywords && $current_keywords != $form_state['input']['search_keywords']) {
      $_SESSION[SBAC_SEARCH_DIGITAL_LIBRARY_RESOURCES_FILTERS] = '';
    }
  }
  $_SESSION[SBAC_SEARCH_DIGITAL_LIBRARY_KEYWORDS] = $form_state['input']['search_keywords'];
}

/**
 * Returns the category filters.
 *
 * @return null
 */
function sbac_search_my_resources_categories() {
  $categories = array();
  drupal_add_css(drupal_get_path('module', 'sbac_search') . '/css/sbac_search.css');
  drupal_add_js(drupal_get_path('module', 'sbac_search') . '/js/sbac_search.my_resources.categories.js');

  $resource_states = taxonomy_vocabulary_machine_name_load('resource_states');
  $resource_states_terms = taxonomy_get_tree($resource_states->vid);
  $allowed_states = array('Draft', 'Submitted', 'In Review', 'Returned', 'Posted', 'Removed');
  foreach ($resource_states_terms as $key => $resource_state_term) {
    if (!in_array($resource_state_term->name, $allowed_states)) {
      unset($resource_states_terms[$key]);
    }
  }
  $categories['resource_states']['display_name'] = 'Resource States';
  $categories['resource_states']['vocabulary'] = $resource_states;
  $categories['resource_states']['terms'] = $resource_states_terms;

  $subject = taxonomy_vocabulary_machine_name_load('subject');
  $categories['subject']['display_name'] = 'Subjects';
  $categories['subject']['vocabulary'] = $subject;
  $categories['subject']['terms'] = taxonomy_get_tree($subject->vid);

  $grades = taxonomy_vocabulary_machine_name_load('grades');
  $categories['grades']['display_name'] = 'Grades';
  $categories['grades']['vocabulary'] = $grades;
  $categories['grades']['terms'] = taxonomy_get_tree($grades->vid);

  $focus = taxonomy_vocabulary_machine_name_load('focus');
  $categories['focus']['display_name'] = 'Resource Type';
  $categories['focus']['vocabulary'] = $focus;
  $categories['focus']['terms'] = taxonomy_get_tree($focus->vid);

  $cf_value = NULL;
  $cf_html = array();
  if (isset($_SESSION[SBAC_SEARCH_MY_RESOURCES_FILTERS])) {
    $cf_value = $_SESSION[SBAC_SEARCH_MY_RESOURCES_FILTERS];
    if ($cf_value) {
      $filters = explode('::', $cf_value);
      if ($filters) {
        foreach ($filters as $filter) {
          $filter_info = explode(':', $filter);
          if ($filter_info && sizeof($filter_info) == 2) {
            $vid = $filter_info[0];
            $tid = $filter_info[1];
            if ($vid && $tid) {
              $term = taxonomy_term_load($tid);
              if ($term) {
                $cf_html[] = '<div class="current-filter"><span vid="' . $vid . '" tid="' . $tid . '" class="filter-name">' . $term->name . '</span></div>';
              }
            }
          }
        }
      }
    }
  }

  $output = NULL;
  if ($categories) {
    $output = theme('sbac_my_resources_categories', array('categories' => $categories, 'cf_value' => $cf_value, 'cf_html' => $cf_html));
  }
  return $output;
}

/**
 * Returns the category filters.
 *
 * @return null
 */
function sbac_search_resource_review_categories() {
  global $user;
  $categories = array();
  drupal_add_css(drupal_get_path('module', 'sbac_search') . '/css/sbac_search.css');
  drupal_add_js(drupal_get_path('module', 'sbac_search') . '/js/sbac_search.resource_review.categories.js');

  $both_roles = $rr = $rp = FALSE;
  if (in_array('resource reviewer', $user->roles) && in_array('resource publisher', $user->roles)) {
    $both_roles = TRUE;
  }
  else {
    if (in_array('resource reviewer', $user->roles)) {
      $rr = TRUE;
    }
    if (in_array('resource publisher', $user->roles)) {
      $rp = TRUE;
    }
  }

  $resource_states = taxonomy_vocabulary_machine_name_load('resource_states');
  $resource_states_terms = taxonomy_get_tree($resource_states->vid);
  $allowed_both_states = array('Being Reviewed', 'Needs Review', 'Needs Posting');
  $allowed_rr_states = array('Being Reviewed', 'Needs Review');
  $allowed_rp_states = array('Being Reviewed', 'Needs Posting');
  foreach ($resource_states_terms as $key => $resource_state_term) {
    if ($both_roles) {
      if (!in_array($resource_state_term->name, $allowed_both_states)) {
        unset($resource_states_terms[$key]);
      }
    }
    else if ($rr) {
      if (!in_array($resource_state_term->name, $allowed_rr_states)) {
        unset($resource_states_terms[$key]);
      }
    }
    else if ($rp) {
      if (!in_array($resource_state_term->name, $allowed_rp_states)) {
        unset($resource_states_terms[$key]);
      }
    }
  }
  $categories['resource_states']['display_name'] = 'Resource States';
  $categories['resource_states']['vocabulary'] = $resource_states;
  $categories['resource_states']['terms'] = $resource_states_terms;

  $subject = taxonomy_vocabulary_machine_name_load('subject');
  $categories['subject']['display_name'] = 'Subjects';
  $categories['subject']['vocabulary'] = $subject;
  $categories['subject']['terms'] = taxonomy_get_tree($subject->vid);

  $grades = taxonomy_vocabulary_machine_name_load('grades');
  $categories['grades']['display_name'] = 'Grades';
  $categories['grades']['vocabulary'] = $grades;
  $categories['grades']['terms'] = taxonomy_get_tree($grades->vid);

  $focus = taxonomy_vocabulary_machine_name_load('focus');
  $categories['focus']['display_name'] = 'Resource Type';
  $categories['focus']['vocabulary'] = $focus;
  $categories['focus']['terms'] = taxonomy_get_tree($focus->vid);

  $cf_value = NULL;
  $cf_html = array();
  if (isset($_SESSION[SBAC_SEARCH_RESOURCE_REVIEW_FILTERS])) {
    $cf_value = $_SESSION[SBAC_SEARCH_RESOURCE_REVIEW_FILTERS];
    if ($cf_value) {
      $filters = explode('::', $cf_value);
      if ($filters) {
        foreach ($filters as $filter) {
          $filter_info = explode(':', $filter);
          if ($filter_info && sizeof($filter_info) == 2) {
            $vid = $filter_info[0];
            $tid = $filter_info[1];
            if ($vid && $tid) {
              $term = taxonomy_term_load($tid);
              if ($term) {
                $cf_html[] = '<div class="current-filter"><span vid="' . $vid . '" tid="' . $tid . '" class="filter-name">' . $term->name . '</span></div>';
              }
            }
          }
        }
      }
    }
  }

  $output = NULL;
  if ($categories) {
    $output = theme('sbac_resource_review_categories', array('categories' => $categories, 'cf_value' => $cf_value, 'cf_html' => $cf_html));
  }
  return $output;
}

/**
 * Returns the category filters.
 *
 * @return null
 */
function sbac_search_digital_library_categories() {
  $categories = array();
  drupal_add_css(drupal_get_path('module', 'sbac_search') . '/css/sbac_search.css');
  drupal_add_js(drupal_get_path('module', 'sbac_search') . '/js/sbac_search.digital_library.categories.js');

  $subject = taxonomy_vocabulary_machine_name_load('subject');
  $categories['subject']['display_name'] = 'Subjects';
  $categories['subject']['vocabulary'] = $subject;
  $categories['subject']['terms'] = taxonomy_get_tree($subject->vid);

  $grades = taxonomy_vocabulary_machine_name_load('grades');
  $categories['grades']['display_name'] = 'Grades';
  $categories['grades']['vocabulary'] = $grades;
  $categories['grades']['terms'] = taxonomy_get_tree($grades->vid);

  $attributes = taxonomy_vocabulary_machine_name_load('attributes');
  $categories['attributes']['display_name'] = 'Attributes of the Formative Assessment Process';
  $categories['attributes']['vocabulary'] = $attributes;
  $categories['attributes']['terms'] = taxonomy_get_tree($attributes->vid);

  $digital_media_type = taxonomy_vocabulary_machine_name_load('digital_media_type');
  $categories['digital_media_type']['display_name'] = 'Media Types';
  $categories['digital_media_type']['vocabulary'] = $digital_media_type;
  $categories['digital_media_type']['terms'] = taxonomy_get_tree($digital_media_type->vid);

  $focus = taxonomy_vocabulary_machine_name_load('focus');
  $categories['focus']['display_name'] = 'Resource Type';
  $categories['focus']['vocabulary'] = $focus;
  $categories['focus']['terms'] = taxonomy_get_tree($focus->vid);

  $intended_end_user = taxonomy_vocabulary_machine_name_load('intended_end_user');
  $categories['intended_end_user']['display_name'] = 'Intended End Users';
  $categories['intended_end_user']['vocabulary'] = $intended_end_user;
  $categories['intended_end_user']['terms'] = taxonomy_get_tree($intended_end_user->vid);

  $intended_student_populations = taxonomy_vocabulary_machine_name_load('intended_student_populations');
  $categories['intended_student_populations']['display_name'] = 'Intended Student Populations';
  $categories['intended_student_populations']['vocabulary'] = $intended_student_populations;
  $categories['intended_student_populations']['terms'] = taxonomy_get_tree($intended_student_populations->vid);

  $educational_use = taxonomy_vocabulary_machine_name_load('educational_use');
  $categories['educational_use']['display_name'] = 'Educational Use';
  $categories['educational_use']['vocabulary'] = $educational_use;
  $categories['educational_use']['terms'] = taxonomy_get_tree($educational_use->vid);

  $smarter_balanced_keyword = taxonomy_vocabulary_machine_name_load('smarter_balanced_keyword');
  $categories['smarter_balanced_keyword']['display_name'] = 'Smarter Balanced Keywords';
  $categories['smarter_balanced_keyword']['vocabulary'] = $smarter_balanced_keyword;
  $categories['smarter_balanced_keyword']['terms'] = taxonomy_get_tree($smarter_balanced_keyword->vid);

  $geographical_settings = taxonomy_vocabulary_machine_name_load('geographical_settings');
  $categories['geographical_settings']['display_name'] = 'Geographic Settings';
  $categories['geographical_settings']['vocabulary'] = $geographical_settings;
  $categories['geographical_settings']['terms'] = taxonomy_get_tree($geographical_settings->vid);

  $cf_value = NULL;
  $cf_html = array();
  if (isset($_SESSION[SBAC_SEARCH_DIGITAL_LIBRARY_RESOURCES_FILTERS])) {
    $cf_value = $_SESSION[SBAC_SEARCH_DIGITAL_LIBRARY_RESOURCES_FILTERS];
    if ($cf_value) {
      $filters = explode('::', $cf_value);
      if ($filters) {
        foreach ($filters as $filter) {
          $filter_info = explode(':', $filter);
          if ($filter_info && sizeof($filter_info) == 2) {
            $vid = $filter_info[0];
            $tid = $filter_info[1];
            if ($vid && $tid) {
              $term = taxonomy_term_load($tid);
              if ($term) {
                $cf_html[] = '<div class="current-filter"><span vid="' . $vid . '" tid="' . $tid . '" class="filter-name">' . $term->name . '</span></div>';
              }
            }
          }
        }
      }
    }
  }

  $output = NULL;
  if ($categories) {
    $output = theme('sbac_digital_library_categories', array('categories' => $categories, 'cf_value' => $cf_value, 'cf_html' => $cf_html));
  }
  return $output;
}

/**
 * Implements hook_form_alter().
 *
 * @param $form
 * @param $form_state
 * @param $form_id
 */
function sbac_search_form_alter(&$form, &$form_state, $form_id) {
  if ($form_id == 'search_block_form') {
    unset($form['#submit']);
    $form['search_block_form']['#attributes'] = array('id' => 'sbac-search-textbox');
    if (isset($_SESSION[SBAC_SEARCH_DIGITAL_LIBRARY_KEYWORDS])) {
      $form['search_block_form']['#default_value'] = $_SESSION[SBAC_SEARCH_DIGITAL_LIBRARY_KEYWORDS];
    }
    if (current_path() != 'digital-library-resources') {
      $form['#action'] = '/digital-library-resources';
      $form['#submit'][] = 'sbac_search_form_submit';
    }
  }
}

/**
 * Submit handler for search submission.
 *
 * @param $form
 * @param $form_state
 */
function sbac_search_form_submit(&$form, &$form_state) {
  $_SESSION[SBAC_SEARCH_DIGITAL_LIBRARY_KEYWORDS] = $form_state['input']['search_block_form'];
}

/**
 * Implementation of hook_theme()
 */
function sbac_search_theme($existing, $type, $theme, $path) {
  $items['sbac_digital_library_categories'] = array(
    'path' => drupal_get_path('module', 'sbac_search') . '/templates',
    'template' => 'digital-library-categories',
    'variables' => array(
      'categories' => NULL,
      'cf_value' => NULL,
      'cf_html' => NULL,
    ),
  );

  $items['sbac_my_resources_categories'] = array(
    'path' => drupal_get_path('module', 'sbac_search') . '/templates',
    'template' => 'my-resources-categories',
    'variables' => array(
      'categories' => NULL,
      'cf_value' => NULL,
      'cf_html' => NULL,
    ),
  );

  $items['sbac_resource_review_categories'] = array(
    'path' => drupal_get_path('module', 'sbac_search') . '/templates',
    'template' => 'resource-review-categories',
    'variables' => array(
      'categories' => NULL,
      'cf_value' => NULL,
      'cf_html' => NULL,
    ),
  );

  return $items;
}
